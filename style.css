const loginBtn = document.getElementById('login-btn');
const authPage = document.getElementById('auth-page');
const chatPage = document.getElementById('chat-page');
const chatViewport = document.getElementById('chat-viewport');
const userInput = document.getElementById('user-input');
const chatMessages = document.getElementById('chat-messages');

loginBtn.addEventListener('click', async () => {
    try {
        const user = await puter.auth.signIn();
        if (user) {
            window.history.pushState({}, '', '/aichat');
            authPage.classList.add('hidden');
            chatPage.classList.remove('hidden');
        }
    } catch (e) {
        console.error("Login failed", e);
    }
});

userInput.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter' && userInput.value.trim() !== "") {
        const query = userInput.value;
        userInput.value = "";
        
        chatViewport.classList.add('zoom-active');
        appendMsg('USER', query);

        try {
            if (!puter.auth.isSignedIn()) {
                await puter.auth.signIn();
            }
            const response = await puter.ai.chat(query, { model: 'google-gemini-3-pro' });
            renderAI(response.toString());
        } catch (err) {
            renderAI("Session error. Please refresh and log in again.");
        }
    }
});

function appendMsg(role, text) {
    const div = document.createElement('div');
    div.style.marginBottom = "20px";
    div.innerHTML = `<small style="color:#94a3b8">${role}</small><div>${text}</div>`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function renderAI(text) {
    const div = document.createElement('div');
    div.style.marginBottom = "20px";
    div.innerHTML = `<small style="color:#60a5fa">PRYSMISAI</small><div class="content" style="position:relative;"></div>`;
    chatMessages.appendChild(div);
    
    const target = div.querySelector('.content');
    const words = text.split(' ');
    
    for(let i=0; i<words.length; i++) {
        const span = document.createElement('span');
        span.className = 'word';
        span.style.animationDelay = `${i * 0.03}s`;
        span.textContent = words[i] + ' ';
        target.appendChild(span);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    setTimeout(() => {
        const line = document.createElement('div');
        line.className = 'neural-line scan-active';
        target.appendChild(line);
        setTimeout(() => chatViewport.classList.remove('zoom-active'), 1000);
    }, words.length * 30 + 400);
}
